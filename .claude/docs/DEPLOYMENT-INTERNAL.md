# Plugin Deployment - Internal Documentation

> **Status**: Internal Only (excluded from distribution)
> **Last Updated**: 2026-01-23
> **Version**: 4.4.30

---

## Troubleshooting History (2026-01-23)

### Problem: Infinite Recursion in Plugin Cache

**Symptom**:
```
ENAMETOOLONG: name too long, copyfile
'/Users/.../.claude/plugins/cache/claude-pilot/claude-pilot/4.4.x/claude-pilot/4.4.x/...'
```

**Root Cause**:
- Marketplace name = Plugin name = `claude-pilot`
- Claude Code cache path: `{marketplace}/{plugin}/{version}/`
- Same repo used for both marketplace and plugin source
- Result: Recursive loop creating infinite nested directories

### Failed Attempts

| Version | Attempt | Result |
|---------|---------|--------|
| 4.4.22 | Remove `pluginRoot` from marketplace.json | Partial fix |
| 4.4.23 | Rename marketplace to `claude-pilot-marketplace` | Still recursive |
| 4.4.24 | Change source format (`github` + `ref`) | 0 available plugins |
| 4.4.25 | Move marketplace.json to release branch, source: `.` | Invalid schema error |
| 4.4.26 | Change source to `./plugins/claude-pilot` | Validation script failed |
| 4.4.27 | Fix validation script | Agent not found error |
| 4.4.28 | Add `claude-pilot:` prefix to source files | Breaks development |
| 4.4.29 | Build-time prefix transformation | Success! |

### Solution: Dual-Branch Strategy

**Key Insight**: Separate development structure from distribution structure.

1. **main branch**: Development-friendly structure
2. **release branch**: Distribution-friendly structure (auto-generated)
3. **Build script**: Transforms main → release with necessary changes

---

## Final Architecture

### Branch Structure

```
main (development)
├── .claude/
│   ├── agents/
│   ├── commands/
│   │   ├── 00_plan.md ... 05_cleanup.md
│   │   └── 999_release.md          ← INTERNAL
│   └── skills/
│       ├── execute-plan/           ← subagent_type: coder
│       └── release/                ← INTERNAL
├── .claude/docs/
│   └── DEPLOYMENT-INTERNAL.md      ← INTERNAL (this file)
├── .claude-plugin/
│   └── plugin.json
└── scripts/
    └── build-marketplace-tree.sh

release (distribution) ← Auto-generated by GitHub Actions
├── .claude-plugin/
│   └── marketplace.json            ← source: "./plugins/claude-pilot"
├── plugins/
│   └── claude-pilot/
│       ├── .claude-plugin/plugin.json
│       ├── agents/
│       ├── commands/               ← 999_release.md EXCLUDED
│       └── skills/                 ← release/ EXCLUDED, prefix ADDED
└── README.md, LICENSE, CHANGELOG.md
```

### Build Transformations

| Item | main | release |
|------|------|---------|
| Directory | `.claude/agents/` | `plugins/claude-pilot/agents/` |
| Agent calls | `coder` | `claude-pilot:coder` |
| 999_release.md | Included | **Excluded** |
| release/ skill | Included | **Excluded** |
| docs/ | Included | **Excluded** |
| marketplace.json | None | **Generated** |

---

## Build Script Details

**File**: `scripts/build-marketplace-tree.sh`

### Key Operations

1. **Copy with exclusions**:
```bash
rsync -a --delete \
  --exclude='999_release.md' \
  --exclude='release/' \
  --exclude='docs/' \
  "$ROOT_DIR/.claude/$dir/" "$PLUGIN_DIR/$dir/"
```

2. **Agent prefix transformation**:
```bash
find "$PLUGIN_DIR/skills" -name "*.md" -exec sed -i '' \
  -e 's/subagent_type: coder/subagent_type: claude-pilot:coder/g' \
  ... \
  {} \;
```

3. **Generate marketplace.json**:
```json
{
  "name": "claude-pilot-marketplace",
  "plugins": [{
    "name": "claude-pilot",
    "source": "./plugins/claude-pilot"
  }]
}
```

---

## Installation Method

```bash
# IMPORTANT: Must use #release branch
/plugin marketplace add changoo89/claude-pilot#release
/plugin install claude-pilot
```

**Why `#release`?**
- main branch has no marketplace.json
- release branch has proper distribution structure
- Prevents infinite recursion (different structure)

---

## Release Process

```bash
/999_release patch   # or minor, major
```

**Automated Steps**:
1. Version bump in plugin.json
2. CHANGELOG generation
3. Git commit + tag (v4.x.x)
4. Push to origin
5. GitHub Actions triggered
6. Build script runs
7. release branch force-pushed

---

## Excluded Files Summary

| File/Directory | Reason |
|----------------|--------|
| `commands/999_release.md` | Internal release workflow |
| `skills/release/` | Internal release skill |
| `.claude/docs/` | Internal documentation |

---

## Debugging Tips

### Check release branch content
```bash
git fetch origin release
git ls-tree origin/release --name-only
git ls-tree origin/release:plugins/claude-pilot/commands --name-only
```

### Verify agent prefix applied
```bash
git show origin/release:plugins/claude-pilot/skills/execute-plan/SKILL.md | grep "subagent_type:"
```

### Manual marketplace cache update
```bash
rm -rf ~/.claude/plugins/marketplaces/claude-pilot
git clone --branch release --single-branch \
  https://github.com/changoo89/claude-pilot.git \
  ~/.claude/plugins/marketplaces/claude-pilot
```

### Check known_marketplaces.json
```bash
cat ~/.claude/plugins/known_marketplaces.json | jq '.["claude-pilot"]'
# Must have: "ref": "release"
```

---

## Lessons Learned

1. **Marketplace ≠ Plugin name**: Must be different to avoid cache collision
2. **Source path matters**: `"."` is invalid, use `"./plugins/name"`
3. **Plugin namespace**: Installed plugins prefix agents with `plugin-name:`
4. **Build-time transformation**: Keeps development simple, handles distribution complexity
5. **Separate concerns**: Internal tools shouldn't be distributed

---

**Document Version**: 1.0
**Author**: Claude Opus 4.5
