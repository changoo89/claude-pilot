# claude-pilot CLI Implementation

- Generated: 2025-01-13 20:01:45 | Work: claude_pilot_cli
- Location: .pilot/plan/pending/20250113_200145_claude_pilot_cli.md

---

## User Requirements

1. Implement Python CLI like moai-adk with commands: `claude-pilot update`, `claude-pilot version`
2. Fix current `install.sh` error caused by missing `.claude/guides/review-extensions.md` file (returns 404)
3. Enable simple update workflow: `claude-pilot update` instead of long curl command

---

## PRP Analysis

### What (Functionality)

**Objective**: Create a Python CLI package that provides `claude-pilot` command with `update` and `version` subcommands, similar to moai-adk.

**Scope**:
- ✅ In scope: Python CLI with update/version commands
- ✅ In scope: PyPI-ready package structure
- ✅ In scope: Fix install.sh missing file issue
- ❌ Out of scope: Complex features like worktree management
- ❌ Out of scope: init command (future enhancement)

### Why (Context)

**Current State**: Users must remember and run long curl commands for updates:
```bash
curl -fsSL https://raw.githubusercontent.com/changoo89/claude-pilot/main/install.sh | bash -s -- update
```

**Desired State**: Simple CLI commands:
```bash
claude-pilot update
claude-pilot version
```

**Business Value**:
- Improved developer experience
- Easier updates with memorable commands
- Alignment with moai-adk patterns
- Professional CLI tool feel

### How (Approach)

- **Phase 1**: Fix immediate issue (remove missing file from install.sh MANAGED_FILES)
- **Phase 2**: Create Python CLI package structure (pyproject.toml, src layout)
- **Phase 3**: Implement CLI commands using Click library
- **Phase 4**: Update install.sh to optionally install the CLI
- **Phase 5**: Testing and documentation

### Success Criteria

```
SC-1: Missing file error fixed
- Verify: Run install.sh update, no 404 errors
- Expected: All downloads succeed (17 files, 0 failures)

SC-2: CLI installable via pip/uv
- Verify: pip install . or uv tool install .
- Expected: claude-pilot command available in PATH

SC-3: update command works
- Verify: claude-pilot update
- Expected: Downloads and updates managed files, shows progress

SC-4: version command works
- Verify: claude-pilot version
- Expected: Shows current and latest version comparison
```

### Constraints

- Python 3.11+ required (modern Python features)
- Minimal dependencies (click, requests only)
- Must work alongside existing install.sh (not replace it)
- Backward compatible with current installation

---

## Scope

### In Scope
- Python package structure with src layout
- CLI entry point via pyproject.toml
- `version` command: show current/latest version
- `update` command: download and update managed files
- Fix install.sh MANAGED_FILES list
- Update install.sh to offer CLI installation

### Out of Scope
- Publishing to PyPI (manual step for user)
- Complex worktree management (moai-adk feature)
- `init` command for new projects
- Shell completion scripts

---

## Architecture

### Project Structure (New Files)

```
claude-pilot/
├── pyproject.toml              # NEW: Python package config
├── src/
│   └── claude_pilot/           # NEW: Python package
│       ├── __init__.py         # Package init with version
│       ├── __main__.py         # Entry point for python -m
│       ├── cli.py              # Click CLI commands
│       ├── updater.py          # Update logic (download files)
│       └── config.py           # Configuration constants
├── install.sh                  # MODIFY: Remove missing file, add CLI install
└── .claude/
    └── guides/                 # Directory doesn't need to exist
```

### Module Boundaries

| Module | Responsibility | Lines Target |
|--------|---------------|--------------|
| `cli.py` | CLI commands, user interaction | ≤100 |
| `updater.py` | File download, update logic | ≤150 |
| `config.py` | Constants, managed files list | ≤50 |
| `__init__.py` | Version, package metadata | ≤20 |
| `__main__.py` | Entry point | ≤10 |

### Code Quality Requirements
- All functions must include type hints (PEP 484)
- Request timeout: 30 seconds for all network calls
- Graceful error handling with user-friendly messages

### Entry Points (pyproject.toml)

```toml
[project.scripts]
claude-pilot = "claude_pilot.cli:main"
```

### Dependencies

```toml
dependencies = [
    "click>=8.1.0",
    "requests>=2.28.0",
]
```

---

## Vibe Coding Compliance

> Validate plan enforces coding standards:

| Target | Limit | Plan Compliance |
|--------|-------|-----------------|
| Function | ≤50 lines | ✅ Each function single responsibility |
| Files | ≤200 lines | ✅ Split into 5 modules |
| Nesting | ≤3 levels | ✅ Early returns, simple logic |
| SRP | Single responsibility | ✅ Each module has clear purpose |
| DRY | No repetition | ✅ Config centralized |
| KISS | Keep simple | ✅ Minimal dependencies |

---

## Execution Plan

### Phase 1: Fix Missing File References (Quick Fix)
- [ ] Remove `.claude/guides/review-extensions.md` from MANAGED_FILES array in `install.sh:168`
- [ ] Remove reference to review-extensions.md from `CLAUDE.md:286` (Related Documentation section)
- [ ] Test install.sh update command works without errors

### Phase 2: Python Package Setup
- [ ] Create `pyproject.toml` with:
  - Project metadata (name, version, description)
  - Dependencies (click, requests)
  - Entry points (claude-pilot command)
  - Build system (hatchling)
- [ ] Create `src/claude_pilot/__init__.py` with version
- [ ] Create `src/claude_pilot/__main__.py` entry point

### Phase 3: CLI Implementation
- [ ] Create `src/claude_pilot/config.py`:
  - VERSION constant
  - REPO_BASE URL
  - MANAGED_FILES list (sync with install.sh)
  - USER_FILES list
- [ ] Create `src/claude_pilot/updater.py`:
  - `get_current_version()` function
  - `get_latest_version()` function
  - `download_file()` function
  - `update_files()` function
- [ ] Create `src/claude_pilot/cli.py`:
  - Click group `main`
  - `version` command
  - `update` command with progress display

### Phase 4: Integration
- [ ] Update `install.sh` to add optional CLI installation:
  - Check if pip/uv available
  - Offer to install claude-pilot CLI
  - Add shell alias suggestion for convenience
- [ ] Test: `pip install .` works
- [ ] Test: `claude-pilot version` works
- [ ] Test: `claude-pilot update` works

### Phase 5: Documentation
- [ ] Update README.md with:
  - New CLI installation method
  - CLI usage examples
  - Comparison with curl method

---

## Acceptance Criteria

- [ ] `install.sh update` runs without 404 errors
- [ ] `pip install .` successfully installs claude-pilot CLI
- [ ] `claude-pilot version` shows version information
- [ ] `claude-pilot update` downloads and updates managed files
- [ ] All managed files match between install.sh and config.py
- [ ] README updated with CLI usage

---

## Test Plan

| ID | Scenario | Input | Expected | Type |
|----|----------|-------|----------|------|
| TS-1 | Version display | `claude-pilot version` | Shows "Current: X.Y.Z, Latest: X.Y.Z" | Unit |
| TS-2 | Update needed | `claude-pilot update` (outdated) | Downloads files, shows progress | Integration |
| TS-3 | Already current | `claude-pilot update` (current) | Shows "Already up to date" | Unit |
| TS-4 | Install.sh fix | `curl ... \| bash -s -- update` | No 404 errors, all files downloaded | Integration |
| TS-5 | Package install | `pip install .` | Command available in PATH | Integration |
| TS-6 | Network timeout | Mock slow server | Timeout after 30s, show error | Unit |
| TS-7 | File download failure | Mock 404 response | Graceful error, continue others | Unit |
| TS-8 | Version file missing | No .pilot-version | Default to "0.0.0" | Unit |

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Python not installed | Low | High | Keep bash install.sh as primary method |
| PyPI name conflict | Medium | Medium | Use `claude-pilot-cli` if needed |
| Network errors during update | Medium | Low | Add retry logic, graceful error messages |
| Version file missing | Low | Low | Default to "0.0.0" if not found |

---

## Open Questions

1. **PyPI Publishing**: Should we publish to PyPI or keep local install only?
   - Recommendation: Start with local, add PyPI later

2. **CLI vs install.sh**: Should CLI replace install.sh or work alongside?
   - Recommendation: Work alongside, CLI is optional enhancement

3. **Shell Aliases**: Should install.sh add shell aliases automatically?
   - Recommendation: Suggest but don't auto-add (user preference)

---

## Review History

### Review #1 (2025-01-13 20:05)

**Findings Applied**:
| Type | Count | Applied |
|------|-------|---------|
| Critical | 1 | 1 |
| Warning | 2 | 2 |
| Suggestion | 2 | 0 (optional) |

**Changes Made**:
1. **[Critical] Execution Plan Phase 1 - Missing CLAUDE.md update**
   - Issue: Plan only mentioned install.sh but CLAUDE.md:286 also references non-existent file
   - Applied: Added step to update CLAUDE.md

2. **[Warning] Architecture - No type hints requirement**
   - Issue: Python code should include type hints for maintainability
   - Applied: Added "Code Quality Requirements" section with type hints mandate

3. **[Warning] Test Plan - Missing unit tests for edge cases**
   - Issue: No tests for network timeout, download failure, missing version file
   - Applied: Added TS-6, TS-7, TS-8 test scenarios

**Review Assessment**: ✅ Pass (all critical/warning findings applied)

---

## Execution Summary

### Changes Made

#### Phase 1: Fixed Missing File References ✅
- **install.sh**: Removed `.claude/guides/review-extensions.md` from MANAGED_FILES array (line 168)
- **CLAUDE.md**: Removed reference to review-extensions.md from Related Documentation section
- **Verification**: `install.sh update` now completes without 404 errors (16 files downloaded)

#### Phase 2: Python Package Setup ✅
- **pyproject.toml**: Created with project metadata, dependencies (click, requests), entry points
- **src/claude_pilot/__init__.py**: Package initialization with version constant
- **src/claude_pilot/__main__.py**: Module entry point for `python -m claude_pilot`
- **Note**: Python requirement adjusted from 3.11+ to 3.9+ for broader compatibility

#### Phase 3: CLI Implementation ✅
- **src/claude_pilot/config.py**: Configuration constants (VERSION, REPO_BASE, MANAGED_FILES, etc.)
- **src/claude_pilot/updater.py**: Update logic (get_current_version, get_latest_version, download_file, update_files, perform_update)
- **src/claude_pilot/cli.py**: Click CLI commands (version, update) with colored output
- **Design**: Fixed circular dependency by using `click.echo` directly in updater.py

#### Phase 4: Integration ✅
- **install.sh**: Added `check_python_pip()` and `offer_cli_install()` functions to offer CLI installation after main install
- **Verification**:
  - `pip3 install .` succeeded
  - `claude-pilot version` works (shows current vs latest version)
  - `claude-pilot update` works (downloads 16 files, updates version)

#### Phase 5: Documentation ✅
- **README.md**: Added "Option 4: Python CLI (New!)" section with installation and usage
- **README.md**: Updated Updates section to show CLI as alternative to curl
- **README.md**: Updated Project Structure to include `src/claude_pilot/` directory

### Files Created
1. `pyproject.toml` - Python package configuration
2. `src/claude_pilot/__init__.py` - Package initialization
3. `src/claude_pilot/__main__.py` - Module entry point
4. `src/claude_pilot/config.py` - Configuration constants
5. `src/claude_pilot/updater.py` - Update logic
6. `src/claude_pilot/cli.py` - Click CLI commands

### Files Modified
1. `install.sh` - Removed missing file reference, added CLI installation offer
2. `CLAUDE.md` - Removed review-extensions.md reference
3. `README.md` - Added CLI documentation, updated project structure

### Verification Summary

| Success Criteria | Status | Verification |
|-----------------|--------|--------------|
| SC-1: Missing file error fixed | ✅ | install.sh update: 16 files, 0 failures |
| SC-2: CLI installable via pip | ✅ | pip3 install . succeeded |
| SC-3: update command works | ✅ | claude-pilot update: 16 files downloaded |
| SC-4: version command works | ✅ | Shows current vs latest version |

### Known Considerations
1. **Python Version**: Adjusted requirement from 3.11+ to 3.9+ for broader compatibility (system Python 3.9)
2. **PATH Warning**: CLI installs to user base bin which may not be in PATH (documented in output)
3. **SSL Warning**: urllib3 shows LibreSSL warning (cosmetic, doesn't affect functionality)

### Follow-ups
1. Consider publishing to PyPI for easier installation (`pip install claude-pilot`)
2. Add unit tests for edge cases (network timeout, download failure, missing version file)
3. Add shell completion support for bash/zsh
4. Consider implementing `init` command for new projects

### Installation Instructions for Users

```bash
# Option 1: Install CLI via pip
cd /path/to/claude-pilot
pip3 install .

# Option 2: install.sh will offer CLI installation
curl -fsSL https://raw.githubusercontent.com/changoo89/claude-pilot/main/install.sh | bash

# Usage
claude-pilot version
claude-pilot update
```

---

**Execution Status**: ✅ Complete
**Date**: 2025-01-13
**All Acceptance Criteria Met**: Yes
